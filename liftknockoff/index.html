<!DOCTYPE html>

<html>
	<head>
		<meta charset = "utf-8"/>
		<title>The Private Car Service</title>
		<link rel = "stylesheet" href = "lift.css" />
	</head>

	<body>
		<div id="myMap"></div>
		<script>
			var myMap;
			var curLoc;
			var closMarkName;
			var closWiener = Number.MAX_VALUE;
			var closMark = Number.MAX_VALUE;
			var vehMap;
			//setting up map
			function initMap() {
				console.log("Test"+ curLoc);
				var myOptions = {
					zoom: 17,
					center: curLoc 
				}
				myMap = new google.maps.Map(document.getElementById("myMap"), myOptions);
				acquireLocation();
			}
			//getting the location
			function acquireLocation(){
				if(navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position) {
						curLoc = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
						console.log("Whyyyyyyyyyyyyyyy"+ curLoc);
						myMap.panTo(curLoc);
						reqRespHeroku();
					});
				}
				else {
					alert("Geolocation doesn't work on this browser...");
				}
				console.log("Testing here...");
				console.log("T2st" + curLoc);
				console.log("end heroku");
			}
			function createMyMarker(){
				console.log(curLoc.lng());
				var myMarker = new google.maps.Marker({
					position: curLoc,
					map: myMap,
					icon: 'foles.jpg' 
				});
				var contentString = buildString();
				var myWindow = new google.maps.InfoWindow({
					content: contentString 
				});
				myMarker.addListener('click', function() {
          				myWindow.open(myMap, myMarker);
        			});
				myMap.addListener('click', function() {
					myWindow.close();
				});

			}
			function buildString(){
				var vehString;
				if(vehMap) {
					vehString = 'vehicle';
				}
				else {
					vehString = 'passenger';
				}
				var myString = '<h1>6MZk3neb</h1>' +
						'<p>Closest ' + vehString + ' away is ' + closMarkName + ', ' + closMark + 'mi away!</p>';
				if (closWiener == Number.MAX_Value){
					myString += 'Oh no! Can\'t find the Wienermobile!';
				}
				else {
					console.log("Here is the value:" + closWiener);
					myString += 'The Wienermobile is ' + closWiener + 'mi away!';
				}
				return myString;
			}
			function reqRespHeroku() {
				var xml = new XMLHttpRequest();
				xml.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
				xml.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
				xml.onreadystatechange = function () {
					//console.log(xml.readyState + "jfkdsl" + "xml.status" + xml.status);
					if(xml.readyState == 4 && xml.status == 200) {
						console.log("Recieved Data");
						myData = JSON.parse(xml.responseText);
						console.log(myData);
						if("vehicles" in myData) {
							vehMap = true;
						}
						else {
							vehMap = false;
						}
						for (i = 0; i < myData['vehicles'].length; i++) {
							console.log("Success?");
							createMarkers(myData['vehicles'][i]);
						}
						createMyMarker();
						
					}
					else {
						console.log("something's wrong...");
					}
				}
				xml.send("username=6MZk3neb&lat="+ curLoc.lat() +"&lng="+ curLoc.lng());
			}
			function createMarkers(idMark) {
				var theLoc; 				
				var objType;
				if(vehMap) {
					objType = 'vehicles';
				}
				else {
					objType = 'passengers';
				}
				theLoc = new google.maps.LatLng(idMark['lat'], idMark['lng']);
				var imgURL = chooseImage(objType, idMark['username']);
				var objMarker = new google.maps.Marker({
					position: theLoc,
					map: myMap,
					icon: imgURL
				});
				var distanceBW = distCheck(theLoc, idMark['username']);
				var infowindow = new google.maps.InfoWindow({
					content: "<h2>" + idMark['username'] + "</h2>" + 
						"<p>They're " + distanceBW + "miles away!</p>"
				});
				objMarker.addListener('click', function() {
          				infowindow.open(myMap, objMarker);
        			});

			}
			function chooseImage(vehPas, user) {
				if(user == "WEINERMOBILE"){
					return "weinermobile.png";
				}
				else if(vehPas == "vehicles") {
					return "car.png";
				}
				else {
					return "passenger.png";
				}
			}
			function distCheck(latLon, user) {
				dist = google.maps.geometry.spherical.computeDistanceBetween(curLoc, latLon);
				dist /= 1609.344;
				if(dist < closMark) {
					closMark = dist;
		     			closMarkName = user;
				}
				if(user == "WEINERMOBILE" && dist < closWiener) {
					console.log("meatywieners"+ dist);
					closWiener = dist;
					console.log("wiener" + closWiener);
				}
				return dist;
			}
		</script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk&callback=initMap&libraries=geometry" async defer></script>
	</body>
</html>
